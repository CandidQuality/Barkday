<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barkday™ • Dog → Human Years</title>
  <meta name="description" content="Dog-year birthdays: calculate the next one and get a plan for better care." />

  <style>
    :root{ --bg:#0b0c10; --card:#13151a; --text:#e8ecf1; --muted:#9aa4af; --brand:#4aa3ff; --accent:#6ae3b2; --danger:#ff6b6b; --border:#232734; --shadow:0 6px 24px rgba(0,0,0,.35); }
    :root[data-theme="light"]{ --bg:#f7f8fa; --card:#ffffff; --text:#0f172a; --muted:#475569; --brand:#2563eb; --accent:#059669; --danger:#b91c1c; --border:#e2e8f0; --shadow:0 6px 24px rgba(2,6,23,.08); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}

    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .title{display:flex;gap:12px;align-items:center}
    .logoImg{width:48px;height:auto;display:block;filter:drop-shadow(0 2px 4px rgba(0,0,0,.25))}
    .toggle{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow)}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    h1{font-size:24px;margin:0}
    h2{font-size:18px;margin:0 0 8px}
    label{font-weight:600;display:block;margin:14px 0 6px}
    input[type="number"], select, input[type="date"], input[type="text"]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--bg);color:var(--text)}
    input[type="range"]{width:100%}
    .row{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap}
    .row > div{flex:1 1 240px;min-width:220px}
    .muted{color:var(--muted);font-size:14px}
    .divider{height:1px;background:var(--border);margin:12px -16px}

    .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:12px}
    .pill{border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.05));border-radius:14px;padding:10px 12px}
    .pill h3{margin:0 0 6px;font-size:15px;color:var(--muted);font-weight:600}
    .big{font-size:24px;font-weight:800}
    .headline{font-size:26px;font-weight:900;line-height:1.15;margin:0 0 4px}
    .primary{outline:2px solid var(--brand);}
    .btn{appearance:none;border:1px solid var(--border);background:var(--brand);color:white;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.secondary{background:transparent;color:var(--text)}

    .cardlist{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .gift{border:1px solid var(--border);border-radius:12px;padding:12px}
    .gift h4{margin:0 0 6px}
    .link{background:none;border:0;color:var(--brand);cursor:pointer;text-decoration:underline;padding:0}
    .hero{margin:4px 0 0 60px}
    .warn{background:rgba(255,107,107,.1);border:1px solid var(--danger);color:var(--danger);padding:8px 10px;border-radius:10px;margin:8px 0}

    /* Plan lanes */
    .plan{margin-top:12px}
    .lane{border:1px solid var(--border);border-radius:12px;padding:12px;margin:8px 0;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.04))}
    .lane h4{margin:0 0 6px;font-size:15px;color:var(--muted)}
    .lane ul{margin:0;padding-left:18px}
    .lane li{margin:4px 0}

    /* Splash */
    .splash{
      position:fixed; inset:0; display:grid; place-items:center;
      background:radial-gradient(1000px 500px at 20% 10%, rgba(255,255,255,.06), transparent),
                 radial-gradient(1000px 500px at 80% 90%, rgba(255,255,255,.05), transparent),
                 var(--bg);
      z-index:9999; transition:opacity .5s ease; opacity:1;
    }
    .splash.hide{ opacity:0; pointer-events:none }
    .splash .logoWrap{
      /* No fixed width/height — renders at natural/original PNG size */
      display:grid; place-items:center; border-radius:20px;
      /* keep the drop shadow effect */
      filter:drop-shadow(0 6px 16px rgba(0,0,0,.45));
    }
    .splash .logoWrap img{
      /* Natural size: no constraints. If image is very large, it can overflow — by request. */
      width:auto; height:auto; max-width:none; max-height:none;
      image-rendering:auto;
    }
  </style>

  <!-- Two-source logo loader (file-based, no base64). -->
  <script>
    // Bump versions to bust cache as needed.
    const LOGO_SPLASH_SRC = "barkday-logo.png?v=3";   // original, full-size on splash
    const LOGO_HEADER_SRC = "barkday-logo2.png?v=3";  // smaller header mark

    // Fail-safe splash autohide regardless of other code paths
    (function(){
      const hideSplash = () => {
        const s = document.getElementById("splash");
        if (s) s.classList.add("hide");
      };
      window.addEventListener("load", () => setTimeout(hideSplash, 1800));
      document.addEventListener("DOMContentLoaded", () => setTimeout(hideSplash, 1500));
    })();

    // Assign both logos once DOM is ready
    window.addEventListener("DOMContentLoaded", () => {
      const h = document.getElementById("logoHeader");
      const s = document.getElementById("logoSplash");
      if (h) h.src = LOGO_HEADER_SRC;
      if (s) s.src = LOGO_SPLASH_SRC;
    });
  </script>
</head>
<body>
  <!-- SPLASH -->
  <div id="splash" class="splash" aria-hidden="true">
    <div class="logoWrap">
      <img id="logoSplash" alt="Barkday logo" src="">
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="title">
        <img id="logoHeader" class="logoImg" alt="Barkday logo" src="">
        <h1>Barkday™</h1>
      </div>
      <button id="themeToggle" class="toggle" type="button" aria-label="Toggle theme">🌙 Dark</button>
    </header>

    <p id="heroLine" class="muted hero">Let’s find out together what your precious friend’s birthdays are, so we can celebrate every single one.</p>

    <section class="card">
      <h2>Dog → Human Years</h2>
      <p class="muted">Evidence-based calculator using AVMA/AKC milestones (15/9 rule) with a <strong>weight-continuous slope</strong> after year 2. Optional UCSD DNA-methylation curve (≥ 1 yr). <em>Calculate/Reset only — no auto-recalc.</em></p>
      <div class="divider"></div>

      <div class="row">
        <div>
          <label for="dogName">Dog name</label>
          <input id="dogName" type="text" placeholder="e.g., Sebastian" />
        </div>
        <div>
          <label for="dob">Birthdate</label>
          <input id="dob" type="date" />
          <div class="muted">Dog age shown under Results.</div>
        </div>
        <div>
          <label for="adultWeight">Expected adult weight (lb)</label>
          <input id="adultWeight" type="range" min="5" max="200" step="5" value="55" />
          <div class="muted">Aging rate uses <em>5-lb steps</em>. <span id="adultWeightVal">55</span> lb</div>
        </div>
        <div>
          <label for="chewer">Chewer level</label>
          <select id="chewer">
            <option>Gentle</option>
            <option selected>Normal</option>
            <option>Power</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Advanced</label>
          <label class="muted"><input id="showEpigenetic" type="checkbox"/> Show science curve (?) (UCSD DNA-methylation, ≥ 1 yr)</label>
          <label class="muted"><input id="smoothMilestones" type="checkbox" checked/> Use smooth milestones (blend around 12 & 24 months)</label>
        </div>
        <div>
          <label for="breed">Breed (optional)</label>
          <input id="breed" type="text" placeholder="e.g., Australian Shepherd" />
          <div class="muted">Notes only — math stays weight-based.</div>
        </div>
        <div>
          <label for="breedGroup">Breed group</label>
          <select id="breedGroup">
            <option>Working / Herding</option>
            <option>Sporting</option>
            <option>Hound</option>
            <option>Terrier</option>
            <option>Toy</option>
            <option>Non-Sporting</option>
            <option>Guardian</option>
            <option>Companion</option>
            <option>Mixed / Other</option>
          </select>
          <div id="breedExamples" class="muted" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <label class="muted"><input id="ignoreAge" type="checkbox"/> Ignore age filter</label>
        <label class="muted"><input id="ignoreSize" type="checkbox"/> Ignore size filter</label>
        <label class="muted"><input id="ignoreChewer" type="checkbox"/> Ignore chewer filter</label>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="calcBtn" class="btn" type="button">Calculate</button>
        <button id="resetBtn" class="btn secondary" type="button">Reset</button>
        <button id="shareBtn" class="btn secondary" type="button">Share link</button>
      </div>

      <div id="sizeWarn" class="warn" style="display:none"></div>

      <div class="divider"></div>

      <h2>Results</h2>
      <div class="kpi">
        <div class="pill primary">
          <div class="headline" id="nextHeadline">—</div>
          <div class="big" id="nextBday">—</div>
          <div class="muted" id="nextBdayDelta"></div>
        </div>
        <div class="pill"><h3>Dog age today</h3><div class="big" id="dogAge">—</div></div>
        <div class="pill"><h3>Human-years estimate</h3><div class="big" id="humanYears">—</div><div class="muted" id="slopeNote"></div></div>
      </div>
      <p id="profileLine" class="muted" style="margin:8px 0 0">—</p>
      <div id="breedNotes" class="muted" style="margin:6px 0 0"></div>

      <div class="row" style="margin-top:10px">
        <button id="addCalBtn" class="btn" type="button">Add to calendar (birthday)</button>
        <button id="remindBtn" class="btn secondary" type="button">Add 1-week reminder</button>
        <button id="addYearSeries" class="btn secondary" type="button">Add next 3 dog-year birthdays</button>
      </div>

      <div id="epi" class="muted" style="margin-top:10px"></div>

      <div class="divider"></div>

      <h2 id="nextPlanHeading">Next Birthday Plan</h2>
      <div id="nextPlan" class="plan"></div>

      <div class="divider"></div>

      <h2>Gift ideas</h2>
      <button id="loadGifts" class="btn secondary" type="button">Load gift ideas</button>
      <div id="giftMeta" class="muted" style="margin:8px 0"></div>
      <div id="gifts" class="cardlist"></div>
    </section>
  </div>

  <script>
    // Theme toggle (persists)
    const root=document.documentElement, themeBtn=document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('barkday-theme') || 'dark';
    root.setAttribute('data-theme', savedTheme==='light'?'light':'dark');
    themeBtn.textContent = savedTheme==='light' ? '🌙 Dark' : '☀️ Light';
    themeBtn.addEventListener('click', () => {
      const now = root.getAttribute('data-theme')==='light'?'dark':'light';
      root.setAttribute('data-theme', now); localStorage.setItem('barkday-theme', now);
      themeBtn.textContent = now==='light' ? '🌙 Dark' : '☀️ Light';
    });

    // Shortcuts
    const $ = id => document.getElementById(id);
    const els = {
      dogName: $('dogName'), dob: $('dob'), adultWeight: $('adultWeight'), adultWeightVal: $('adultWeightVal'),
      chewer: $('chewer'), showEpi: $('showEpigenetic'), smooth: $('smoothMilestones'), breed: $('breed'), breedGroup: $('breedGroup'),
      ignoreAge: $('ignoreAge'), ignoreSize: $('ignoreSize'), ignoreChewer: $('ignoreChewer'),
      calcBtn: $('calcBtn'), resetBtn: $('resetBtn'), shareBtn: $('shareBtn'), sizeWarn: $('sizeWarn'),
      nextHeadline: $('nextHeadline'), nextBday: $('nextBday'), nextBdayDelta: $('nextBdayDelta'),
      dogAge: $('dogAge'), humanYears: $('humanYears'), slopeNote: $('slopeNote'),
      addCal: $('addCalBtn'), remind: $('remindBtn'), addYearSeries: $('addYearSeries'),
      loadGifts: $('loadGifts'), giftMeta: $('giftMeta'), gifts: $('gifts'), heroLine: $('heroLine'), profileLine: $('profileLine'), breedNotes: $('breedNotes'), epi: $('epi')
    };

    // Personalized hero line
    const poss = n => !n ? "your precious friend's" : (/\s*$/.test(n)&&/s$/i.test(n.trim())? n.trim()+"’" : n.trim()+"’s");
    function renderHero(){ els.heroLine.textContent = `Let’s find out together what ${poss(els.dogName.value)} birthdays are, so we can celebrate every single one.`; }
    els.dogName.addEventListener('input', renderHero); renderHero();

    // Breed examples + notes
    const GROUP_META = {
      'Working / Herding': { desc:'High-drive problem solvers; thrive on jobs.', examples:['Border Collie','Australian Shepherd','German Shepherd','Belgian Malinois','Corgi'] },
      'Sporting': { desc:'Endurance & retrieving; water-confident.', examples:['Labrador','Golden Retriever','Vizsla','GSP','Setter'] },
      'Hound': { desc:'Scent/sight specialists; independent.', examples:['Beagle','Dachshund','Greyhound','Foxhound','Basset'] },
      'Terrier': { desc:'Tenacious hunters; love dig/chase.', examples:['JRT','Westie','Airedale','Border Terrier'] },
      'Toy': { desc:'Small frames; fragile joints.', examples:['Chihuahua','Pomeranian','Yorkie','Maltese','Papillon'] },
      'Non-Sporting': { desc:'Mixed roles; varied needs.', examples:['Bulldog','Dalmatian','Poodle (Std)','Boston Terrier'] },
      'Guardian': { desc:'Large/giant protectors.', examples:['Rottweiler','Mastiff','Great Dane','Anatolian','Kuvasz'] },
      'Companion': { desc:'Human-bonded routines.', examples:['Cavapoo','Cockapoo','Shih Tzu','Havanese'] },
      'Mixed / Other': { desc:'Profile by drive & size.', examples:['Mixed-breed','Rescue','Unknown'] }
    };
    const GROUPS = {
      'Working / Herding':['Daily jobs/puzzles (herding games, scentwork).','Mental as important as physical; enrichment.','Prevent under-stimulation → boredom.'],
      'Sporting':['Structured fetch/dock/field games.','Watch weight; measured meals.'],
      'Hound':['Scent walks on long line; recall with high-value rewards.'],
      'Terrier':['Dig boxes, flirt poles, controlled tug.'],
      'Toy':['Low-impact play; dental care; temperature care.'],
      'Non-Sporting':['Tailor enrichment to individual needs.'],
      'Guardian':['Impulse control & neutrality; joint support.'],
      'Companion':['Reinforce calm independence; routines.'],
      'Mixed / Other':['Profile by observed drive (retrieve, scent, herd).']
    };
    function updateBreedNotes(){
      const name = els.dogName.value || 'your dog';
      const breedTxt = (els.breed.value||'').trim();
      const group = els.breedGroup.value;
      const lb = parseInt(els.adultWeight.value,10) || 55;
      els.profileLine.textContent = `Profile: ${name}${breedTxt ? ' — ' + breedTxt : ''} • Group: ${group} • Weight: ${lb} lb`;
      const notes = GROUPS[group]||[]; els.breedNotes.innerHTML = notes.map(n=>`• ${n}`).join(' ');
      const meta = GROUP_META[group]; const bx = $('breedExamples');
      bx.textContent = meta ? `${meta.desc} Examples: ${meta.examples.join(', ')}` : '';
    }
    ['input','change'].forEach(ev=>{
      els.breed.addEventListener(ev, updateBreedNotes);
      els.breedGroup.addEventListener(ev, updateBreedNotes);
      els.dogName.addEventListener(ev, updateBreedNotes);
      els.adultWeight.addEventListener(ev, updateBreedNotes);
    });
    updateBreedNotes();

    // Slider label (5-lb steps)
    els.adultWeight.addEventListener('input', ()=>{ const v=Math.round(parseInt(els.adultWeight.value,10)/5)*5; els.adultWeight.value=v; els.adultWeightVal.textContent=v; });

    // Utils
    const clamp=(n,min,max)=>Math.min(Math.max(n,min),max);
    const daysBetween=(a,b)=>Math.floor((b-a)/(24*60*60*1000));
    const pad2=n=>String(n).padStart(2,'0');
    const fmtUTC=d=>d.getUTCFullYear()+pad2(d.getUTCMonth()+1)+pad2(d.getUTCDate())+'T'+pad2(d.getUTCHours())+pad2(d.getUTCMinutes())+pad2(d.getUTCSeconds())+'Z';

    // Weight → slope (5→~7.2)
    function slopeFromWeight(lb){ const w=clamp(lb,5,200); if(w<=20) return 5; if(w<=50) return 5+(w-20)*(1/30); if(w<=90) return 6+(w-50)*(1/40); return 7+(w-90)*(0.2/110); }
    function smoothBlend(x,c,w){ const t=clamp((x-(c-w/2))/w,0,1); return t*t*(3-2*t); }
    function humanEqYears(tY, lb, smooth){
      const R=slopeFromWeight(lb);
      if(!smooth){ if(tY<=1) return 15*tY; if(tY<=2) return 15+9*(tY-1); return 24+R*(tY-2); }
      const f1=smoothBlend(tY,1,.25), slope12=15+f1*(9-15);
      if(tY<=2){ const a=Math.min(tY,1)*15; const b=tY>1?(tY-1)*slope12:0; return a+b; }
      const f2=smoothBlend(tY,2,.5), post=9+f2*(R-9), upto2=humanEqYears(2,lb,true);
      return upto2+(tY-2)*post;
    }
    function nextDogYearDate(dob, H, lb, smooth){
      const target=Math.floor(H)+1, now=new Date();
      const yearsNow=daysBetween(dob, now)/365.2425;
      let lo=yearsNow, hi=yearsNow+5;
      for(let i=0;i<40;i++){ const mid=(lo+hi)/2; const h=humanEqYears(mid,lb,smooth); if(h>=target) hi=mid; else lo=mid; }
      const t=(lo+hi)/2; return new Date(dob.getTime()+t*365.2425*24*60*60*1000);
    }

// Multicolor confetti (blue-forward palette)
function confetti(ms = 2700){
  const c=document.createElement('canvas'); c.style.position='fixed'; c.style.inset='0'; c.style.pointerEvents='none';
  c.width=innerWidth; c.height=innerHeight; document.body.appendChild(c);
  const ctx=c.getContext('2d');

  // palette: blue + accent pops
  const colors=['#4aa3ff','#6ae3b2','#ffd166','#ff6b6b','#a78bfa'];
  const N=180;
  const parts=Array.from({length:N},()=>({
    x:Math.random()*c.width,
    y:-20-Math.random()*60,
    vx:(Math.random()-.5)*4,
    vy:2+Math.random()*3,
    g:0.05+Math.random()*0.06,
    s:4+Math.random()*5,
    c:colors[(Math.random()*colors.length)|0],
    r:Math.random()*Math.PI
  }));

  let st=null;
  (function tick(ts){
    if(!st) st=ts;
    const t=ts-st;
    ctx.clearRect(0,0,c.width,c.height);

    for(const p of parts){
      p.x+=p.vx; p.y+=p.vy; p.vy+=p.g; p.r+=0.06;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r);
      ctx.fillStyle=p.c; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s);
      ctx.restore();
    }

    if(t<ms) requestAnimationFrame(tick); else c.remove();
  })(0);
}

    // Banded recommendations (seed; expand later)
    const AGE_BANDS = [
      { key:'puppy_1_6',min:1,max:6,label:'Puppy I (1–6 dog-years)' },
      { key:'puppy_7_10',min:7,max:10,label:'Puppy II (7–10 dog-years)' },
      { key:'puppy_11_15',min:11,max:15,label:'Puppy III (11–15 dog-years)' },
      { key:'young_16_24',min:16,max:24,label:'Young (16–24 dog-years)' },
      { key:'adult_25_60',min:25,max:60,label:'Adult (25–60 dog-years)' },
      { key:'senior_61p',min:61,max:999,label:'Senior (61+ dog-years)' }
    ];
    const bandForDY = dy => AGE_BANDS.find(b=>dy>=b.min && dy<=b.max) || AGE_BANDS[AGE_BANDS.length-1];
    const RECO_BANDED = {
      "Working / Herding": {
        puppy_1_6:{lanes:{ training:["Name/marker 1–3 min, 3–5×/day","Gentle handling (paws/ears/mouth)","Crate = calm naps; short positive entries","Potty schedule after sleep/eat/play"],
                         health:["Puppy vaccine series; deworm","Parasite prevention","Set up x-pen / safe confinement"],
                         nutrition:["Puppy diet; 3–4 small meals/day","Weigh weekly; track BCS"],
                         exercise:["Free play on soft surfaces","Short leash intros; sniff & explore","No big jumps; carry stairs if possible"],
                         bonding:["Friendly people/dogs socialization","Groom/brush + treats"],
                         gear:["Light Y-front harness","Snuffle/lick mat; puppy teether"]}},
        puppy_7_10:{lanes:{ training:["Recall on 15–30 ft line","Settle on mat (1–3 → 5–7 min)","Leave-it & polite greetings"],
                            health:["Series continues; spay/neuter timing","Teething: supervised chews"],
                            nutrition:["Maintain puppy diet; growth curve"],
                            exercise:["2–3 short sniff-walks (5–15 min)","Avoid repetitive fetch/jumps"],
                            bonding:["Puzzle feeders 3–4×/week","Easy nosework (3–5 hides)"],
                            gear:["Biothane long line; treat pouch","Level-1/2 puzzle; soft tug"]}}
      }
    };
    const RECO = {}; // placeholder for per-breed exact points later

    function planFor(group, dogYears){
      const band = bandForDY(Math.round(dogYears));
      const plan = (RECO_BANDED[group]||{})[band.key];
      if (plan) return { plan, band };
      const g = (RECO[group] || RECO['Mixed / Other'] || {}), keys=Object.keys(g).map(k=>+k).sort((a,b)=>a-b);
      if(!keys.length) return { plan:null, band }; let lo=null, up=null; for(const k of keys){ if(k<=dogYears) lo=k; if(k>=dogYears && up===null) up=k; }
      const chosen=(lo!==null)?lo:up; return { plan:g[chosen]||null, band };
    }
    function renderPlan(group, upcomingDY){
      const box=$('nextPlan'); box.innerHTML=''; const {plan,band}=planFor(group,upcomingDY);
      const head=$('nextPlanHeading'); head.textContent = `Next Birthday Plan — ${band?band.label:('turning '+upcomingDY)}`;
      if(!plan){ box.innerHTML='<div class="muted">Recommendations coming soon.</div>'; return; }
      const order=[['training','Training & Enrichment'],['health','Health & Wellness'],['nutrition','Diet & Nutrition'],['exercise','Exercise Needs'],['bonding','Play & Bonding Ideas'],['gear','Helpful Gear (optional)']];
      for(const [k,label] of order){
        const items=(plan.lanes&&plan.lanes[k])?plan.lanes[k]:[]; if(!items.length) continue;
        const d=document.createElement('div'); d.className='lane'; d.innerHTML=`<h4>${label}</h4>`; const ul=document.createElement('ul');
        items.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); }); d.appendChild(ul); box.appendChild(d);
      }
    }

    // Gift feed (URL hidden from UI)
    const GIFT_FEED_URL = 'https://raw.githubusercontent.com/CandidQuality/dog-birthday-feed/main/dog-gifts.json';
    async function loadGifts(){
      els.gifts.innerHTML=''; els.giftMeta.textContent='Loading…';
      try{
        const res = await fetch(GIFT_FEED_URL,{cache:'no-store'}); const items = await res.json();
        const lb = parseInt(els.adultWeight.value,10);
        const bucket = lb<20?'toy':lb<30?'small':lb<50?'medium':lb<90?'large':'giant';
        const dogYears = parseFloat(els.humanYears.textContent);
        const chewer = (els.chewer.value||'').toLowerCase();

        const results = [];
        for(const it of items){
          let ok = true, score = 0;
          const sizes = (Array.isArray(it.sizes)? it.sizes : (it.size? String(it.size).split(/[, \t]+/):[])).map(s=>String(s).toLowerCase());
          const sizeOK = !sizes.length || sizes.includes('any') || sizes.includes(bucket);
          if(!els.ignoreSize.checked && !sizeOK) ok=false; else if(sizeOK) score++;

          const chewTag = (it.chewer? String(it.chewer).toLowerCase() : 'any');
          const chewOK = chewTag==='any' || chewTag===chewer;
          if(!els.ignoreChewer.checked && !chewOK) ok=false; else if(chewOK) score++;

          const minDY = it.minDogYears ?? null, maxDY = it.maxDogYears ?? null;
          let ageOK = true;
          if(!isNaN(dogYears) && !els.ignoreAge.checked){
            if(minDY!=null) ageOK = ageOK && dogYears >= Number(minDY);
            if(maxDY!=null) ageOK = ageOK && dogYears <= Number(maxDY);
            if(minDY==null && maxDY==null && it.tag){
              const t=String(it.tag).toLowerCase();
              if(t.includes('puppy')) ageOK = dogYears<=15;
              else if(t.includes('senior')) ageOK = dogYears>=61;
            }
          }
          if(!els.ignoreAge.checked && !ageOK) ok=false; else if(ageOK) score++;

          if(ok) results.push({it, score, rnd:Math.random()});
        }
        results.sort((a,b)=> (b.score-a.score) || (a.rnd-b.rnd));
        const top = results.slice(0,12).map(r=>r.it);

        const parts=[]; parts.push(`size=${bucket}`); parts.push(`chewer=${chewer||'normal'}`); if(!isNaN(dogYears)) parts.push(`age≈${dogYears.toFixed(2)} DY`);
        const ignored=[]; if(els.ignoreSize.checked) ignored.push('size'); if(els.ignoreChewer.checked) ignored.push('chewer'); if(els.ignoreAge.checked) ignored.push('age');
        els.giftMeta.textContent = `Showing ${top.length} picks • ${parts.join(' • ')}${ignored.length? ' • ignored: '+ignored.join(', '):''}`;
        els.gifts.innerHTML = top.map(it=>`<div class="gift"><h4>${it.title||'Gift'}</h4><div class="muted">${(it.tag||it.ageTag||'').toString()}</div><div style="margin-top:8px"><a class="link" href="${it.url}" target="_blank" rel="noopener">View</a></div></div>`).join('');
      }catch(e){ els.giftMeta.textContent='Could not load gift ideas.'; }
    }
    $('loadGifts').addEventListener('click', loadGifts);

    // Compute (manual)
    function compute(){
      const dobStr=els.dob.value; if(!dobStr){ alert('Please select a birthdate.'); return; }
      const dob=new Date(dobStr), now=new Date(); if(isNaN(dob)||dob>now){ alert('Birthdate is invalid.'); return; }
      const lb=parseInt(els.adultWeight.value,10);

      // Chronological age
      const days=daysBetween(dob, now), years=days/365.2425, yrs=Math.floor(years), months=Math.floor((years%1)*12);
      els.dogAge.textContent = `${yrs}y ${months}m`;

      // Dog-years
      const H=humanEqYears(years, lb, els.smooth.checked); els.humanYears.textContent=H.toFixed(2); const R=slopeFromWeight(lb); els.slopeNote.textContent=`R≈${R.toFixed(2)} (weight-continuous)`;

      // Next dog-year birthday
      const name=els.dogName.value || 'your dog';
      const upcoming=Math.floor(H)+1;
      els.nextHeadline.textContent = `${name} is about to be ${upcoming} years old!`;
      const nbd=nextDogYearDate(dob,H,lb,els.smooth.checked); els.nextBday.textContent=nbd.toDateString(); const dTo=daysBetween(now, nbd); els.nextBdayDelta.textContent = dTo>0? `${dTo} days from now` : '';

      // Profile/notes
      const breedTxt=(els.breed.value||'').trim(); const group=els.breedGroup.value;
      els.profileLine.textContent = `Profile: ${name}${breedTxt?' — '+breedTxt:''} • Group: ${group} • Weight: ${lb} lb`;
      els.breedNotes.innerHTML = (GROUPS[group]||[]).map(n=>`• ${n}`).join(' ');

      // Weight/group hint
      let warn=''; if(group.includes('Toy') && lb>30) warn='Breed group "Toy" but weight > 30 lb. Math stays weight-based.'; if((group.includes('Guardian')||group.includes('Working')) && lb<20) warn='Breed group suggests large/giant, but weight < 20 lb. Math stays weight-based.';
      els.sizeWarn.style.display = warn? 'block':'none'; els.sizeWarn.textContent = warn;

      // Celebrate & plan
      confetti(); renderPlan(group, upcoming);

      // Epigenetic note (no chart for now)
      els.epi.textContent = els.showEpi.checked ? 'Science curve: UCSD DNA-methylation (≥ 1 yr). Note: visualization context; math remains weight-based.' : '';
      if(!els.showEpi.checked) els.epi.textContent = '';

      // If gifts open, refilter
      if(els.gifts.children.length) loadGifts();
    }

    // Buttons
    $('calcBtn').addEventListener('click', compute);
    $('resetBtn').addEventListener('click', ()=>{
      els.dogName.value=''; els.dob.value=''; els.adultWeight.value=55; els.adultWeightVal.textContent='55'; els.chewer.value='Normal';
      els.showEpi.checked=false; els.smooth.checked=true; els.breed.value=''; els.breedGroup.value='Working / Herding';
      els.ignoreAge.checked=els.ignoreSize.checked=els.ignoreChewer.checked=false;
      els.nextHeadline.textContent='—'; els.nextBday.textContent='—'; els.nextBdayDelta.textContent='';
      els.dogAge.textContent='—'; els.humanYears.textContent='—'; els.slopeNote.textContent='';
      $('nextPlan').innerHTML=''; $('nextPlanHeading').textContent='Next Birthday Plan';
      els.sizeWarn.style.display='none'; els.gifts.innerHTML=''; els.giftMeta.textContent=''; els.epi.textContent='';
      renderHero(); updateBreedNotes();
    });
    $('shareBtn').addEventListener('click', ()=>{
      const p=new URLSearchParams({ n:els.dogName.value||'', d:els.dob.value||'', w:els.adultWeight.value, c:els.chewer.value, g:els.breedGroup.value, r:els.breed.value||'', s:els.smooth.checked?1:0, e:els.showEpi.checked?1:0 });
      const url=location.origin+location.pathname+'?'+p.toString();
      navigator.clipboard.writeText(url).then(()=>alert('Shareable link copied.')).catch(()=>alert(url));
    });

    // Calendar downloads
    $('addCalBtn').addEventListener('click', ()=>{
      if(!els.nextBday.textContent || els.nextBday.textContent==='—'){ alert('Calculate first.'); return; }
      const start=new Date(els.nextBday.textContent), end=new Date(start.getTime()+60*60*1000);
      const name=els.dogName.value||'Your dog';
      const ics=`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Barkday//EN
BEGIN:VEVENT
UID:${Date.now()}@barkday
DTSTAMP:${fmtUTC(new Date())}
DTSTART:${fmtUTC(start)}
DTEND:${fmtUTC(end)}
SUMMARY:${name} — Next Dog-Year Birthday
END:VEVENT
END:VCALENDAR`;
      const blob=new Blob([ics],{type:'text/calendar'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='barkday.ics'; document.body.appendChild(a); a.click(); a.remove();
    });
    $('remindBtn').addEventListener('click', ()=> alert('Reminder integration placeholder.'));
    $('addYearSeries').addEventListener('click', ()=>{
      if(!els.dob.value){ alert('Calculate first.'); return; }
      const name=els.dogName.value||'Your dog', dob=new Date(els.dob.value), lb=parseInt(els.adultWeight.value,10);
      const now=new Date(), years=daysBetween(dob, now)/365.2425, H=humanEqYears(years, lb, els.smooth.checked);
      let cur=nextDogYearDate(dob, H, lb, els.smooth.checked), dogYears=Math.floor(H)+1;
      let ics='BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Barkday//EN\n';
      for(let i=0;i<3;i++){
        const start=cur, end=new Date(start.getTime()+60*60*1000);
        ics+=`BEGIN:VEVENT\nUID:${Date.now()+Math.random()}@barkday\nDTSTAMP:${fmtUTC(new Date())}\nDTSTART:${fmtUTC(start)}\nDTEND:${fmtUTC(end)}\nSUMMARY:${name} — Dog-Year ${dogYears}\nEND:VEVENT\n`;
        dogYears++; cur=nextDogYearDate(dob, dogYears-1, lb, els.smooth.checked);
      }
      ics+='END:VCALENDAR'; const blob=new Blob([ics],{type:'text/calendar'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='barkday_series.ics'; document.body.appendChild(a); a.click(); a.remove();
    });

    // Gifts auto-refilter if visible
    function reloadGiftsIfShown(){ if(els.gifts.children.length>0){ loadGifts(); } }
    ['change'].forEach(ev=>{
      els.adultWeight.addEventListener(ev, reloadGiftsIfShown);
      els.chewer.addEventListener(ev, reloadGiftsIfShown);
      els.ignoreAge.addEventListener(ev, reloadGiftsIfShown);
      els.ignoreSize.addEventListener(ev, reloadGiftsIfShown);
      els.ignoreChewer.addEventListener(ev, reloadGiftsIfShown);
    });

    // QS hydrate (no auto compute)
    (function initFromQS(){
      const q=new URLSearchParams(location.search); if(!q.size) return;
      els.dogName.value=q.get('n')||''; els.dob.value=q.get('d')||''; els.adultWeight.value=q.get('w')||55; els.adultWeightVal.textContent=els.adultWeight.value;
      els.chewer.value=q.get('c')||'Normal'; els.breedGroup.value=q.get('g')||'Working / Herding'; els.breed.value=q.get('r')||'';
      els.smooth.checked=q.get('s')==='1'; els.showEpi.checked=q.get('e')==='1';
      renderHero(); updateBreedNotes();
    })();
  </script>
</body>
</html>
